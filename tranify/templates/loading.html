{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Progress - Trainify</title>
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/upload.css' %}">
    <style>
        .progress-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .progress-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .training-details {
            margin-top: 1rem;
        }

        .model-progress {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .current-epoch {
            font-weight: bold;
            color: #2196F3;
        }

        .metrics {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <main>
        <section class="login-container">
            <h2>Start Your Project!!!</h2>
            <form id="training-form" action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Original form fields remain the same -->
                <label for="project-name">Project Name:</label>
                <input type="text" id="project-name" name="project_name" placeholder="Enter project name" class="login-input" required>
                
                <label for="dataset">Upload Dataset (ZIP):</label>
                <input type="file" id="dataset" name="dataset" accept=".zip" class="login-input" required>

                <label for="epochs">Number of Epochs:</label>
                <input type="number" id="epochs" name="epochs" min="10" max="50" placeholder="Enter number of epochs" class="login-input" required>

                <label>Select Model(s):</label>
                <div class="model-options">
                    <div><input type="checkbox" name="models" value="alexnet"> <label>AlexNet</label></div>
                    <div><input type="checkbox" name="models" value="vgg16"> <label>VGG16</label></div>
                    <div><input type="checkbox" name="models" value="resnet50"> <label>ResNet50</label></div>
                    <div><input type="checkbox" name="models" value="mobilenetv2"><label>MobileNetV2</label></div>
                </div>

                <button type="submit">Submit</button>
                
                <center>
                    {% if messages %}
                    <p style="color: red;">
                        {% for message in messages %}
                            {{message}}
                        {% endfor %}
                    </p>
                    {% endif %}
                </center>
            </form>
        </section>
    </main>

    <!-- Progress Modal -->
    <div id="progress-container" class="progress-container">
        <div class="progress-content">
            <h3>Training in Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="training-details">
                <p>Project: <span id="project-name-display"></span></p>
                <p>Current Model: <span id="current-model"></span></p>
                <div id="model-progress"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Trainify. All Rights Reserved.</p>
    </footer>

    <script>
        document.getElementById('training-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.querySelector('.progress-fill');
            const projectNameDisplay = document.getElementById('project-name-display');
            const currentModel = document.getElementById('current-model');
            const modelProgress = document.getElementById('model-progress');

            // Show progress container
            progressContainer.style.display = 'block';
            projectNameDisplay.textContent = formData.get('project_name');

            // Start training
            fetch('{% url "start_training" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    checkProgress(data.task_id);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                progressContainer.style.display = 'none';
                alert('An error occurred while starting the training.');
            });
        });

        function checkProgress(taskId) {
            const progressInterval = setInterval(() => {
                fetch(`{% url "check_progress" %}?task_id=${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data);
                        if (data.status === 'completed') {
                            clearInterval(progressInterval);
                            window.location.href = data.redirect_url;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        clearInterval(progressInterval);
                    });
            }, 1000);
        }

        function updateProgress(data) {
            const progressFill = document.querySelector('.progress-fill');
            const currentModel = document.getElementById('current-model');
            const modelProgress = document.getElementById('model-progress');

            progressFill.style.width = `${data.overall_progress}%`;
            currentModel.textContent = data.current_model;

            // Update model-specific progress
            modelProgress.innerHTML = `
                <div class="model-progress">
                    <p class="current-epoch">Epoch ${data.current_epoch}/${data.total_epochs}</p>
                    <p class="metrics">
                        Loss: ${data.current_loss.toFixed(4)}<br>
                        Accuracy: ${(data.current_accuracy * 100).toFixed(2)}%
                    </p>
                </div>
            `;
        }
    </script>
</body>
</html>